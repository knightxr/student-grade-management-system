<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>SGMS Browser Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cjrtnc.leaningtech.com/4.2/loader.js"></script>
    <style>
      html,body{height:100%;margin:0;background:#0f1115;color:#e6e6e6;font:14px/1.4 system-ui}
      #log{position:fixed;top:10px;left:10px;background:#1b1e25;border:1px solid #2a2f3a;border-radius:10px;padding:10px 12px;max-width:92vw;z-index:9}
      #log b{color:#ffb4a6}
      .ok{color:#9cd67d}
      .bad{color:#ff7b7b}
    </style>
  </head>
  <body>
    <div id="log">Starting…</div>
    <script>
      const log = (m, cls="") =>
        document.getElementById("log").insertAdjacentHTML("beforeend", `<div class="${cls}">${m}</div>`);

      // ---- Use RELATIVE paths (works under /student-grade-management-system/) ----
      const CP_LIST = [
        "StudentGradeManagementSystem.jar",
        "lib/AbsoluteLayout.jar",
        "lib/commons-lang3-3.8.1.jar",
        "lib/commons-logging-1.2.jar",
        "lib/flatlaf-3.6.jar",
        "lib/hsqldb-2.5.0.jar",
        "lib/jackcess-3.0.1.jar",
        "lib/ucanaccess-5.0.1.jar"
      ];
      const CP = CP_LIST.join(":");

      // DB file you committed alongside the site
      const DB_SITE   = "sgms/data/School.accdb";            // where Pages serves it from
      const DB_TARGET = "/files/src/sgms/data/School.accdb"; // where your Java code will look after toAbsolutePath()

      // Your main class
      const MAIN_CLASS = "sgms.main.StudentGradeManagementSystem";

      // ---- Preflight: make sure everything is actually on GitHub Pages ----
      async function preflight() {
        let ok = true;
        for (const p of [...CP_LIST, DB_SITE]) {
          const res = await fetch(p + "?v=" + Date.now(), { method: "HEAD" });
          if (!res.ok) { ok = false; log(`Missing on server: ${p} (status ${res.status})`, "bad"); }
          else { log(`OK: ${p}`, "ok"); }
        }
        if (!ok) throw new Error("One or more files are missing on GitHub Pages. Fix the red lines above.");
      }

      (async function main() {
        try {
          log("Preflight…");
          await preflight();

          log("Loading CheerpJ runtime…");
          await cheerpjInit();
          cheerpjCreateDisplay(1120, 720);
          log("CheerpJ ready.");

          // Load library with your classpath
          log("Loading Java library (classpath)…");
          const lib   = await cheerpjRunLibrary(CP);
          const System = lib.java.lang.System;
          const NIO   = lib.java.nio.file;
          const Paths = NIO.Paths;
          const Files = NIO.Files;
          const StandardCopyOption = NIO.StandardCopyOption;

          // ---- Copy DB from site (/app resolves to current site) -> writable FS (/files) ----
          log("Preparing database…");

          // CheerpJ exposes overloaded Java statics with typed names:
          // Paths.get(String, String...) => get$java_lang_String$[Ljava_lang_String;
          // Files.createDirectories(Path) => createDirectories$java_nio_file_Path
          // Files.copy(Path,Path,CopyOption...) => copy$java_nio_file_Path$java_nio_file_Path$[Ljava_nio_file_CopyOption;

          const src = await Paths["get$java_lang_String$[Ljava_lang_String;"]("sgms/data/School.accdb", []);
          const dst = await Paths["get$java_lang_String$[Ljava_lang_String;"](DB_TARGET, []);

          await Files["createDirectories$java_nio_file_Path"](dst.getParent());
          await Files["copy$java_nio_file_Path$java_nio_file_Path$[Ljava_nio_file_CopyOption;"](
            src, dst, [StandardCopyOption.REPLACE_EXISTING]
          );

          log("DB copied to " + DB_TARGET);

          // Make your Path.of(...).toAbsolutePath() resolve under /files
          await System.setProperty("user.dir", "/files");
          log('user.dir set to "/files"');

          // ---- Launch your actual app ----
          log("Launching app main…");
          await cheerpjRunMain(MAIN_CLASS, CP);
          log("App launched.");
        } catch (e) {
          log("<b>ERROR</b>: " + (e && (e.stack || e)), "bad");
          console.error(e);
        }
      })();
    </script>
  </body>
</html>
