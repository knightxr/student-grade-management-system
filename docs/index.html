<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>SGMS Browser Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cjrtnc.leaningtech.com/4.2/loader.js"></script>
    <style>
      html,body{height:100%;margin:0;background:#0f1115;color:#e6e6e6;font:14px/1.4 system-ui}
      #log{position:fixed;top:10px;left:10px;background:#1b1e25;border:1px solid #2a2f3a;border-radius:10px;padding:10px 12px;max-width:92vw;z-index:9}
      #log b{color:#ffb4a6}
      .ok{color:#9cd67d}
      .bad{color:#ff7b7b}
    </style>
  </head>
  <body>
    <div id="log">Starting…</div>
    <script>
      const log = (m, cls="") =>
        document.getElementById("log").insertAdjacentHTML("beforeend", `<div class="${cls}">${m}</div>`);

      // ----------------------------
      // Relative paths (project page)
      // ----------------------------
      const CP_REL = [
        "StudentGradeManagementSystem.jar",
        "lib/AbsoluteLayout.jar",
        "lib/commons-lang3-3.8.1.jar",
        "lib/commons-logging-1.2.jar",
        "lib/flatlaf-3.6.jar",
        "lib/hsqldb-2.5.0.jar",
        "lib/jackcess-3.0.1.jar",
        "lib/ucanaccess-5.0.1.jar"
      ];
      const CP_FOR_CJ = CP_REL.map(p => "/app/" + p).join(":"); // what CheerpJ expects

      const DB_SITE_REL = "sgms/data/School.accdb";     // served by Pages
      const DB_SITE_ABS = "/app/" + DB_SITE_REL;        // absolute path in CheerpJ FS
      const DB_TARGET   = "/files/src/sgms/data/School.accdb"; // where your Java code resolves to

      const MAIN_CLASS = "sgms.main.StudentGradeManagementSystem";

      // ---------------------------------
      // Preflight: prove files are on Pages
      // ---------------------------------
      async function preflight() {
        let ok = true;
        for (const p of [...CP_REL, DB_SITE_REL]) {
          const res = await fetch(p + "?v=" + Date.now(), { method: "HEAD" });
          if (!res.ok) { ok = false; log(`Missing on server: ${p} (status ${res.status})`, "bad"); }
          else { log(`OK: ${p}`, "ok"); }
        }
        if (!ok) throw new Error("One or more files are missing on GitHub Pages. Fix the red lines above.");
      }

      (async function main() {
        try {
          log("Preflight…");
          await preflight();

          log("Loading CheerpJ runtime…");
          await cheerpjInit();
          cheerpjCreateDisplay(1120, 720);
          log("CheerpJ ready.");

          // ------------------------------------
          // Copy DB from /app/... -> /files/...
          // ------------------------------------
          log("Preparing database…");
          // NIO only; no need for app classpath to copy a site file
          const lib = await cheerpjRunLibrary("");

          const System = await lib.java.lang.System;
          const Paths  = await lib.java.nio.file.Paths;
          const Files  = await lib.java.nio.file.Files;
          const Opts   = await lib.java.nio.file.StandardCopyOption;

          // Get Path objects (await the results)
          const src = await Paths.get(DB_SITE_ABS, []);   // /app/sgms/data/School.accdb
          const dst = await Paths.get(DB_TARGET, []);     // /files/src/sgms/data/School.accdb
          const parent = await dst.getParent();           // <-- MUST await, returns a Java object

          // Some CheerpJ versions require typed names for overloaded statics.
          // We resolve both typed and plain variants and use whichever exists.
          const Files_createDirectories =
            Files["createDirectories$java_nio_file_Path"] || Files.createDirectories;
          const Files_copy_varargs =
            Files["copy$java_nio_file_Path$java_nio_file_Path$[Ljava_nio_file_CopyOption;"];
          const Files_copy_plain =
            Files["copy$java_nio_file_Path$java_nio_file_Path"] || Files.copy;

          // Create parent dir, then copy (prefer varargs overload; fall back to plain)
          await Files_createDirectories(parent);
          if (Files_copy_varargs) {
            await Files_copy_varargs(src, dst, [Opts.REPLACE_EXISTING]);
          } else {
            await Files_copy_plain(src, dst);
          }
          log("DB copied to " + DB_TARGET);

          // Make your Path.of(...).toAbsolutePath() resolve under /files
          await System.setProperty("user.dir", "/files");
          log('user.dir set to "/files"');

          // -------------------------
          // Launch your real main()
          // -------------------------
          log("Launching app main…");
          await cheerpjRunMain(MAIN_CLASS, CP_FOR_CJ);
          log("App launched.");
        } catch (e) {
          log("<b>ERROR</b>: " + (e && (e.stack || e)), "bad");
          console.error(e);
        }
      })();
    </script>
  </body>
</html>
