<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>SGMS Browser Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cjrtnc.leaningtech.com/4.2/loader.js"></script>
    <style>
      html,body{height:100%;margin:0;background:#0f1115;color:#e6e6e6;font:14px/1.4 system-ui}
      #log{position:fixed;top:10px;left:10px;background:#1b1e25;border:1px solid #2a2f3a;border-radius:10px;padding:10px 12px;max-width:92vw;z-index:9}
      #log b{color:#ffb4a6}
      .ok{color:#9cd67d}
      .bad{color:#ff7b7b}
    </style>
  </head>
  <body>
    <div id="log">Starting…</div>
    <script>
      const log = (m, cls="") => {
        const el = document.getElementById("log");
        el.insertAdjacentHTML("beforeend", `<div class="${cls}">${m}</div>`);
      };

      // ---- Exact filenames present in your repo (analyze from your screenshots) ----
      const CP_LIST = [
        "/app/StudentGradeManagementSystem.jar",
        "/app/lib/AbsoluteLayout.jar",
        "/app/lib/commons-lang3-3.8.1.jar",
        "/app/lib/commons-logging-1.2.jar",
        "/app/lib/flatlaf-3.6.jar",
        "/app/lib/hsqldb-2.5.0.jar",
        "/app/lib/jackcess-3.0.1.jar",
        "/app/lib/ucanaccess-5.0.1.jar"
      ];
      const CP = CP_LIST.join(":");

      // Your DB file placed in docs/sgms/data/ (site) and where the app should read it (writable)
      const DB_SITE   = "/app/sgms/data/School.accdb";
      const DB_TARGET = "/files/src/sgms/data/School.accdb"; // matches Path.of("src","sgms","data","School.accdb")

      // Main class (contains public static void main) per your project tree
      const MAIN_CLASS = "sgms.main.StudentGradeManagementSystem";

      // ---- Small preflight: HEAD each resource so we fail fast if anything is missing on Pages ----
      async function preflight() {
        const required = [...CP_LIST, DB_SITE.replace("/app","") ? DB_SITE : DB_SITE];
        let ok = true;
        for (const p of required) {
          // remove "/app" because fetch is relative to site root; '/app/foo' == 'FOO' on the network
          const url = p.startsWith("/app/") ? p.slice(4) : p;
          const res = await fetch(url + "?v=" + Date.now(), { method: "HEAD" });
          if (!res.ok) { ok = false; log(`Missing on server: ${url} (status ${res.status})`, "bad"); }
          else { log(`OK: ${url}`, "ok"); }
        }
        if (!ok) throw new Error("One or more files are missing on GitHub Pages. Fix the red lines above.");
      }

      (async function main() {
        try {
          log("Preflight…");
          await preflight();

          log("Loading CheerpJ runtime…");
          await cheerpjInit();
          cheerpjCreateDisplay(1120, 720);
          log("CheerpJ ready.");

          log("Loading Java library (classpath)…");
          const lib = await cheerpjRunLibrary(CP);

          // Java handles
          const System = lib.java.lang.System;
          const Paths = lib.java.nio.file.Paths;
          const Files = lib.java.nio.file.Files;
          const StandardCopyOption = lib.java.nio.file.StandardCopyOption;

          // Copy DB from site (/app/…) to writable FS (/files/…)
          log("Preparing database…");
          const src = await Paths.get(DB_SITE, []);
          const dst = await Paths.get(DB_TARGET, []);
          await Files.createDirectories(dst.getParent());
          await Files.copy(src, dst, [StandardCopyOption.REPLACE_EXISTING]);
          log("DB copied to " + DB_TARGET);

          // Make your Path.of(...).toAbsolutePath() resolve under /files
          await System.setProperty("user.dir", "/files");
          log('user.dir set to "/files"');

          // Launch your app
          log("Launching app main…");
          await cheerpjRunMain(MAIN_CLASS, CP);
          log("App launched.");
        } catch (e) {
          log("<b>ERROR</b>: " + (e && (e.stack || e)), "bad");
          console.error(e);
        }
      })();
    </script>
  </body>
</html>
